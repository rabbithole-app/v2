@let currentStep = step();

<hlm-dialog-header>
  <h3 hlmDialogTitle>Upgrade Storage</h3>
  <p hlmDialogDescription>
    @switch (currentStep) {
      @case ('review') {
        Review the available updates for your storage.
      }
      @case ('upgrading') {
        Please wait while your storage is being upgraded...
      }
      @case ('completed') {
        Your storage has been upgraded successfully.
      }
      @case ('error') {
        Something went wrong during the upgrade.
      }
    }
  </p>
</hlm-dialog-header>

@switch (currentStep) {
  @case ('review') {
    <div class="mt-4 space-y-4">
      <!-- Release version info -->
      <div class="flex items-center gap-2 text-sm">
        <span class="text-muted-foreground">Version:</span>
        <span class="font-mono">{{ currentReleaseTag() }}</span>
        <span class="text-muted-foreground">&rarr;</span>
        <span class="font-mono font-medium">{{ availableReleaseTag() }}</span>
      </div>

      <!-- What will be updated -->
      <div class="flex flex-wrap gap-2">
        @if (updateInfo().wasmUpdateAvailable) {
          <span hlmBadge variant="outline" class="text-xs">
            <ng-icon hlmIcon name="lucidePackage" size="xs" />
            WASM Module
          </span>
        }
        @if (updateInfo().frontendUpdateAvailable) {
          <span hlmBadge variant="outline" class="text-xs">
            <ng-icon hlmIcon name="lucideGlobe" size="xs" />
            Frontend
          </span>
        }
      </div>

      <div hlmAlert>
        <ng-icon hlmAlertIcon name="lucideCircleAlert" />
        <h4 hlmAlertTitle>Temporary permissions required</h4>
        <p hlmAlertDesc>
          The backend canister will be temporarily added as a controller of your storage
          to install updates. It will be automatically removed after the upgrade completes.
        </p>
      </div>
    </div>
  }

  @case ('upgrading') {
    <div class="mt-4">
      @if (isPreparing()) {
        <hlm-empty>
          <hlm-empty-header>
            <hlm-empty-media variant="icon">
              <hlm-spinner />
            </hlm-empty-media>
            <h4 hlmEmptyTitle>Granting permissions...</h4>
            <p hlmEmptyDescription>Preparing your storage for the upgrade...</p>
          </hlm-empty-header>
        </hlm-empty>
      } @else if (upgradeStatus(); as status) {
        <rbth-feat-storages-creation-progress [status]="status" mode="upgrade" />
      } @else {
        <hlm-empty>
          <hlm-empty-header>
            <hlm-empty-media variant="icon">
              <hlm-spinner />
            </hlm-empty-media>
            <h4 hlmEmptyTitle>Starting upgrade...</h4>
            <p hlmEmptyDescription>Waiting for the upgrade to begin...</p>
          </hlm-empty-header>
        </hlm-empty>
      }
    </div>
  }

  @case ('error') {
    <div hlmAlert variant="destructive" class="mt-4">
      <ng-icon hlm hlmAlertIcon name="lucideCircleAlert" />
      <h4 hlmAlertTitle>Upgrade Failed</h4>
      <p hlmAlertDescription>{{ errorMessage() }}</p>
    </div>
  }
}

@if (currentStep !== 'upgrading') {
  <hlm-dialog-footer class="mt-4">
    @switch (currentStep) {
      @case ('review') {
        <button hlmBtn variant="outline" brnDialogClose>Cancel</button>
        <button hlmBtn (click)="startUpgrade()">
          <ng-icon hlmIcon name="lucideArrowUpCircle" size="sm" />
          Start Upgrade
        </button>
      }
      @case ('completed') {
        <button hlmBtn brnDialogClose>
          <ng-icon hlmIcon name="lucideCheck" size="sm" />
          Done
        </button>
      }
      @case ('error') {
        <button hlmBtn variant="outline" brnDialogClose>Cancel</button>
        <button hlmBtn (click)="tryAgain()">Try Again</button>
      }
    }
  </hlm-dialog-footer>
}
