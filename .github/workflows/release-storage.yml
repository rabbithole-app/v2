name: Release Storage

on:
  push:
    tags:
      - 'storage-v*' # Trigger on tags like storage-v1.0.0
  workflow_dispatch: # Manual trigger

permissions:
  contents: write # Required to create releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      # Install dependencies
      - run: npm ci --legacy-peer-deps

      # Setup DFX for Motoko compilation
      - name: Setup DFX
        uses: dfinity/setup-dfx@main
        with:
          dfx-version: latest

      # Install mops (required for Motoko dependencies)
      - name: Install mops
        run: npm install -g ic-mops@1.12.0

      # Import DFX identity from GitHub Secret for IC network deployment
      - name: Import DFX Identity
        working-directory: apps/backend
        run: |
          echo "${{ secrets.DFX_IDENTITY_PEM }}" > identity.pem
          dfx identity import --storage-mode plaintext --force release-identity identity.pem || true
          dfx identity use release-identity
          rm -f identity.pem
          echo "✅ Identity imported and activated"

      # Verify identity and canister configuration
      - name: Verify DFX configuration
        working-directory: apps/backend
        run: |
          echo "Current identity: $(dfx identity whoami)"
          echo "Principal: $(dfx identity get-principal)"
          if [ -f canister_ids.json ]; then
            echo "Canister IDs configuration:"
            cat canister_ids.json
          else
            echo "⚠️  canister_ids.json not found"
            exit 1
          fi

      # Build encrypted-storage JS library
      - name: Build encrypted-storage library
        run: npx nx build encrypted-storage

      # Build storage frontend
      - name: Build storage frontend
        run: npx nx build storage --configuration=production

      # Build EncryptedStorageCanister WASM
      # NOTE: For local testing, use: docker compose exec backend dfx build encrypted-storage --network local
      - name: Build EncryptedStorageCanister WASM
        working-directory: apps/backend
        run: |
          mops install
          dfx build encrypted-storage --network ic

      # Generate DID file
      - name: Generate DID file
        working-directory: apps/backend
        run: |
          dfx generate encrypted-storage --network ic

      # Calculate WASM SHA256 hash
      - name: Calculate WASM SHA256
        id: wasm_sha256
        working-directory: apps/backend
        run: |
          WASM_PATH=".dfx/ic/canisters/encrypted-storage/encrypted-storage.wasm"
          if [ -f "$WASM_PATH" ]; then
            SHA256=$(sha256sum "$WASM_PATH" | cut -d' ' -f1)
            echo "sha256=$SHA256" >> $GITHUB_OUTPUT
            echo "WASM SHA256: $SHA256"
          else
            echo "❌ WASM file not found at $WASM_PATH"
            exit 1
          fi

      # Create WASM gzip archive
      - name: Create WASM gzip archive
        working-directory: apps/backend
        run: |
          WASM_PATH=".dfx/ic/canisters/encrypted-storage/encrypted-storage.wasm"
          if [ -f "$WASM_PATH" ]; then
            gzip -c "$WASM_PATH" > ../../encrypted-storage.wasm.gz
            echo "✅ Created encrypted-storage.wasm.gz"
          else
            echo "❌ WASM file not found at $WASM_PATH"
            exit 1
          fi

      # Create frontend tar.gz archive (root in dist/apps/storage/browser)
      # IMPORTANT: GNU gzip creates deflate streams that mo:compression library cannot fully decode.
      # Node.js zlib (based on reference zlib implementation) creates compatible streams.
      - name: Create frontend tar.gz archive
        run: |
          cd dist/apps/storage/browser
          tar -cf - . > ../../../../storage-frontend.tar
          cd ../../../../
          node -e "
            const fs = require('fs');
            const zlib = require('zlib');
            const input = fs.readFileSync('storage-frontend.tar');
            const output = zlib.gzipSync(input, { level: 6 });
            fs.writeFileSync('storage-frontend.tar.gz', output);
          "
          rm storage-frontend.tar
          echo "✅ Created storage-frontend.tar.gz (using Node.js zlib)"

      # Create JS library archive
      - name: Create library archive
        run: |
          cd dist/libs/encrypted-storage
          zip -r ../../../encrypted-storage-lib.zip .
          cd ../../../
          echo "✅ Created encrypted-storage-lib.zip"

      # Copy artifacts to single directory
      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          # WASM files (both raw and gzipped)
          cp apps/backend/.dfx/ic/canisters/encrypted-storage/encrypted-storage.wasm release-artifacts/encrypted-storage.wasm
          cp encrypted-storage.wasm.gz release-artifacts/encrypted-storage.wasm.gz
          # DID file
          cp apps/backend/src/declarations/encrypted-storage/encrypted-storage.did release-artifacts/encrypted-storage.did || \
          cp apps/backend/.dfx/ic/canisters/encrypted-storage/encrypted-storage.did release-artifacts/encrypted-storage.did
          # Archives
          cp storage-frontend.tar.gz release-artifacts/
          cp encrypted-storage-lib.zip release-artifacts/
          # Create checksums.txt
          cd release-artifacts
          sha256sum * > checksums.txt
          echo "✅ Prepared release artifacts"

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifacts/*
          tag_name: ${{ github.ref_name }}
          name: Storage Release ${{ github.ref_name }}
          body: |
            ## Storage Release ${{ github.ref_name }}

            ### Artifacts:
            - **encrypted-storage.wasm** - WASM canister module (uncompressed)
            - **encrypted-storage.wasm.gz** - WASM canister module (gzip compressed, for backend download)
            - **encrypted-storage.did** - Candid interface
            - **storage-frontend.tar.gz** - Frontend application (tar+gzip compressed)
            - **encrypted-storage-lib.zip** - JS library @rabbithole/encrypted-storage
            - **checksums.txt** - SHA256 hashes of all artifacts

            ### WASM SHA256:
            ```
            ${{ steps.wasm_sha256.outputs.sha256 }}
            ```

            ### Verification:
            To verify the installed module matches:
            ```bash
            sha256sum encrypted-storage.wasm
            # Should match the hash above
            ```
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
